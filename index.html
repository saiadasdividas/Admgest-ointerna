<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Treinamento SDR</title>
<!-- Firebase SDK -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Arial', sans-serif;
background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
min-height: 100vh;
color: #333;
}

.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
}

.header {
background: white;
padding: 30px;
border-radius: 20px;
box-shadow: 0 15px 35px rgba(0,0,0,0.1);
margin-bottom: 30px;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
}

.header h1 {
color: #1a365d;
font-size: 2.2rem;
margin-bottom: 5px;
}

.header p {
color: #718096;
font-size: 1.1rem;
}

.admin-login {
display: flex;
gap: 15px;
align-items: center;
}

.admin-login input {
padding: 10px 15px;
border: 2px solid #e2e8f0;
border-radius: 8px;
font-size: 14px;
}

.admin-login input:focus {
outline: none;
border-color: #1a365d;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.stat-card {
background: white;
padding: 25px;
border-radius: 15px;
box-shadow: 0 10px 25px rgba(0,0,0,0.1);
text-align: center;
}

.stat-number {
font-size: 2.5rem;
font-weight: bold;
color: #1a365d;
margin-bottom: 5px;
}

.stat-label {
color: #718096;
font-size: 1rem;
}

.filters-section {
background: white;
padding: 20px;
border-radius: 15px;
box-shadow: 0 10px 25px rgba(0,0,0,0.1);
margin-bottom: 30px;
}

.filters-row {
display: flex;
gap: 15px;
align-items: center;
flex-wrap: wrap;
}

.filter-group {
display: flex;
flex-direction: column;
gap: 5px;
}

.filter-group label {
font-size: 0.9rem;
color: #4a5568;
font-weight: bold;
}

.filter-group select,
.filter-group input {
padding: 8px 12px;
border: 2px solid #e2e8f0;
border-radius: 8px;
font-size: 14px;
}

.sdr-list {
background: white;
border-radius: 15px;
box-shadow: 0 10px 25px rgba(0,0,0,0.1);
overflow: hidden;
}

.sdr-item {
border-bottom: 1px solid #e2e8f0;
transition: background 0.2s ease;
cursor: pointer;
}

.sdr-item:hover {
background: #f7fafc;
}

.sdr-item:last-child {
border-bottom: none;
}

.sdr-header {
padding: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}

.sdr-info {
display: flex;
align-items: center;
gap: 15px;
}

.sdr-avatar {
width: 50px;
height: 50px;
border-radius: 50%;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
font-size: 1.2rem;
}

.sdr-details h3 {
color: #1a365d;
margin-bottom: 5px;
font-size: 1.1rem;
}

.sdr-meta {
color: #718096;
font-size: 0.9rem;
}

.sdr-progress {
display: flex;
align-items: center;
gap: 15px;
}

.progress-circle {
width: 60px;
height: 60px;
border-radius: 50%;
background: conic-gradient(#38a169 0deg, #38a169 0deg, #e2e8f0 0deg);
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
color: #1a365d;
position: relative;
}

.status-badge {
padding: 6px 12px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: bold;
}

.status-active {
background: #c6f6d5;
color: #22543d;
}

.status-completed {
background: #bee3f8;
color: #1a365d;
}

.status-paused {
background: #fed7d7;
color: #742a2a;
}

.sdr-answers {
padding: 20px;
display: none;
background: #f8fafc;
border-radius: 0 0 15px 15px;
border-top: 1px solid #e2e8f0;
}

.sdr-answers.expanded {
display: block;
}

.no-data {
text-align: center;
padding: 40px;
color: #a0aec0;
font-style: italic;
}

.delete-btn {
transition: all 0.2s ease;
}

.delete-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
}

.delete-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

.expand-btn {
transition: transform 0.2s ease;
}

.sdr-item.expanded .expand-btn {
transform: rotate(180deg);
}

.btn {
background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
font-size: 14px;
font-weight: bold;
cursor: pointer;
transition: transform 0.2s ease;
}

.btn:hover {
transform: translateY(-2px);
}

.btn-export {
background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
}

.btn-refresh {
background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
}

.loading {
text-align: center;
padding: 40px;
color: #718096;
}

.loading-spinner {
border: 4px solid #e2e8f0;
border-top: 4px solid #1a365d;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.no-data {
text-align: center;
padding: 40px;
color: #a0aec0;
}

.expand-btn {
background: none;
border: none;
color: #1a365d;
cursor: pointer;
font-size: 1.2rem;
padding: 5px;
border-radius: 5px;
transition: background 0.2s ease;
}

.expand-btn:hover {
background: #edf2f7;
}

.admin-section {
display: none;
}

.admin-section.active {
display: block;
}

@media (max-width: 768px) {
.header {
flex-direction: column;
gap: 20px;
text-align: center;
}

.stats-grid {
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.filters-row {
flex-direction: column;
align-items: stretch;
}

.sdr-header {
flex-direction: column;
gap: 15px;
align-items: flex-start;
}

.sdr-progress {
align-self: flex-end;
}
}
</style>
</head>
<body>
<div class="container">
<!-- Login Admin -->
<div id="adminLogin" class="header">
<div>
<h1>üîê Acesso Administrativo</h1>
<p>Fa√ßa login para acessar o painel de controle</p>
</div>
<div class="admin-login">
<input type="password" id="adminPassword" placeholder="Senha de administrador">
<button class="btn" onclick="loginAdmin()">Entrar</button>
</div>
</div>

<!-- Painel Admin -->
<div id="adminPanel" class="admin-section">
<div class="header">
<div>
<h1>üìä Painel Administrativo</h1>
<p>Treinamento SDR - Monitoramento em Tempo Real</p>
</div>
<div style="display: flex; gap: 10px;">
<button class="btn btn-refresh" onclick="loadData()">üîÑ Atualizar</button>
<button class="btn btn-export" onclick="exportData()">üìä Exportar</button>
<button class="btn" onclick="logoutAdmin()">Sair</button>
</div>
</div>

<!-- Estat√≠sticas -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalSDRs">0</div>
<div class="stat-label">SDRs Cadastrados</div>
</div>
<div class="stat-card">
<div class="stat-number" id="activeSessions">0</div>
<div class="stat-label">Sess√µes Ativas</div>
</div>
<div class="stat-card">
<div class="stat-number" id="completedTrainings">0</div>
<div class="stat-label">Treinamentos Conclu√≠dos</div>
</div>
<div class="stat-card">
<div class="stat-number" id="totalAnswers">0</div>
<div class="stat-label">Respostas Coletadas</div>
</div>
</div>

<!-- Filtros -->
<div class="filters-section">
<div class="filters-row">
<div class="filter-group">
<label>Filtrar por Status:</label>
<select id="statusFilter" onchange="applyFilters()">
<option value="">Todos</option>
<option value="ativo">Ativo</option>
<option value="conclu√≠do">Conclu√≠do</option>
<option value="pausado">Pausado</option>
</select>
</div>
<div class="filter-group">
<label>Buscar SDR:</label>
<input type="text" id="searchSDR" placeholder="Nome ou e-mail" oninput="applyFilters()">
</div>
<div class="filter-group">
<label>Data:</label>
<input type="date" id="dateFilter" onchange="applyFilters()">
</div>
</div>
</div>

<!-- Lista de SDRs -->
<div class="sdr-list" id="sdrList">
<div class="loading">
<div class="loading-spinner"></div>
<p>Carregando dados...</p>
</div>
</div>
</div>
</div>

<script>
// Configura√ß√£o do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAxkOOHB1m2vhleekARWnXyhnTjCt251LQ",
    authDomain: "plataforma-de-treinament-9a00b.firebaseapp.com",
    projectId: "plataforma-de-treinament-9a00b",
    storageBucket: "plataforma-de-treinament-9a00b.firebasestorage.app",
    messagingSenderId: "192125351398",
    appId: "1:192125351398:web:c16cc461c4c853132a1227"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Vari√°veis globais
let allData = [];
let sdrData = {};
const ADMIN_PASSWORD = "admin123"; // Altere para sua senha

// Login Admin
function loginAdmin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASSWORD) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').classList.add('active');
        loadData();
    } else {
        alert('Senha incorreta!');
    }
}

// Logout Admin
function logoutAdmin() {
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminPanel').classList.remove('active');
    document.getElementById('adminPassword').value = '';
}

// Carregar dados do Firebase com tratamento de erro
async function loadData() {
    try {
        // Mostrar loading
        document.getElementById('sdrList').innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Carregando dados...</p>
            </div>
        `;
        
        console.log('Iniciando carregamento de dados...');
        
        // Tentar conectar ao Firestore com timeout
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout na conex√£o')), 10000)
        );
        
        const dataPromise = db.collection('sdr_training')
            .orderBy('timestamp', 'desc')
            .limit(1000) // Limitar para evitar sobrecarga
            .get();
            
        const snapshot = await Promise.race([dataPromise, timeoutPromise]);
        
        console.log('Dados carregados do Firebase. Documentos encontrados:', snapshot.size);
        
        allData = [];
        
        snapshot.forEach(doc => {
            allData.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        console.log('Total de registros processados:', allData.length);
        
        if (allData.length === 0) {
            document.getElementById('sdrList').innerHTML = '<div class="no-data">Nenhum dado encontrado no Firebase</div>';
            updateStats();
            return;
        }
        
        processData();
        renderSDRList();
        updateStats();
        
        console.log('Carregamento conclu√≠do com sucesso');
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        
        let errorMessage = 'Erro desconhecido';
        
        if (error.message.includes('Timeout')) {
            errorMessage = 'Timeout na conex√£o com Firebase';
        } else if (error.code === 'unavailable') {
            errorMessage = 'Firebase indispon√≠vel. Verifique sua conex√£o com internet.';
        } else if (error.code === 'permission-denied') {
            errorMessage = 'Permiss√£o negada. Verifique as regras do Firestore.';
        } else {
            errorMessage = `Erro: ${error.message}`;
        }
        
        document.getElementById('sdrList').innerHTML = `
            <div class="no-data">
                <h3>‚ùå Erro ao carregar dados</h3>
                <p>${errorMessage}</p>
                <button class="btn" onclick="loadData()" style="margin-top: 15px;">üîÑ Tentar novamente</button>
            </div>
        `;
        
        // Ainda tentar atualizar stats mesmo com erro
        sdrData = {};
        updateStats();
    }
}

// Processar dados - vers√£o com debug detalhado
function processData() {
    try {
        console.log('=== INICIANDO PROCESSAMENTO DE DADOS ===');
        console.log('Total de itens brutos:', allData.length);
        
        sdrData = {};
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
            console.warn('allData est√° vazio ou inv√°lido');
            return;
        }
        
        // Debug: mostrar alguns itens brutos
        console.log('Primeiros 3 itens brutos:', allData.slice(0, 3));
        
        // Primeiro, agrupar todos os dados por sessionId
        const sessionGroups = {};
        allData.forEach((item, index) => {
            try {
                if (!item || !item.data || !item.data.sessionId) {
                    console.warn(`Item ${index} inv√°lido ou sem sessionId:`, item);
                    return;
                }
                
                const sessionId = item.data.sessionId;
                if (!sessionGroups[sessionId]) {
                    sessionGroups[sessionId] = [];
                }
                sessionGroups[sessionId].push(item);
            } catch (itemError) {
                console.error(`Erro ao processar item ${index}:`, itemError, item);
            }
        });
        
        console.log('Sessions agrupadas:', Object.keys(sessionGroups));
        console.log('Total de sessions:', Object.keys(sessionGroups).length);
        
        // Processar cada sess√£o
        Object.entries(sessionGroups).forEach(([sessionId, items]) => {
            try {
                console.log(`\n--- Processando sess√£o: ${sessionId} ---`);
                console.log(`Itens na sess√£o: ${items.length}`);
                
                sdrData[sessionId] = {
                    sessionId: sessionId,
                    sdrName: '',
                    sdrEmail: '',
                    startTime: null,
                    status: 'ativo',
                    progress: 0,
                    completedModules: 0,
                    modules: {}
                };
                
                const session = sdrData[sessionId];
                
                // Separar itens por tipo
                const sessionStart = items.find(item => item.type === 'session_start');
                const answers = items.filter(item => item.type === 'answer');
                const progressItems = items.filter(item => item.type === 'progress');
                const completedItems = items.filter(item => item.type === 'training_completed');
                const pausedItems = items.filter(item => item.type === 'session_pause');
                
                console.log('Tipos de itens encontrados:', {
                    sessionStart: !!sessionStart,
                    answers: answers.length,
                    progressItems: progressItems.length,
                    completedItems: completedItems.length,
                    pausedItems: pausedItems.length
                });
                
                // Processar dados da sess√£o
                if (sessionStart && sessionStart.data) {
                    session.sdrName = sessionStart.data.sdrName || '';
                    session.sdrEmail = sessionStart.data.sdrEmail || '';
                    session.startTime = sessionStart.data.startTime;
                    
                    console.log('Dados da sess√£o extra√≠dos:', {
                        nome: session.sdrName,
                        email: session.sdrEmail,
                        startTime: session.startTime
                    });
                } else {
                    console.warn('Session start n√£o encontrado ou inv√°lido para:', sessionId);
                }
                
                // Processar progresso (pegar o mais recente)
                if (progressItems.length > 0) {
                    const latestProgress = progressItems.sort((a, b) => {
                        const dateA = new Date(a.timestamp?.seconds * 1000 || a.timestamp || 0);
                        const dateB = new Date(b.timestamp?.seconds * 1000 || b.timestamp || 0);
                        return dateB - dateA;
                    })[0];
                    
                    if (latestProgress && latestProgress.data) {
                        session.progress = latestProgress.data.progress || 0;
                        session.completedModules = latestProgress.data.completedModules || 0;
                        console.log('Progresso extra√≠do:', session.progress + '%');
                    }
                }
                
                // Processar status
                if (completedItems.length > 0) {
                    session.status = 'conclu√≠do';
                } else if (pausedItems.length > 0) {
                    session.status = 'pausado';
                }
                
                console.log('Status da sess√£o:', session.status);
                
                // Processar respostas - pegar apenas a mais recente de cada pergunta
                console.log(`Processando ${answers.length} respostas...`);
                const uniqueAnswers = {};
                
                answers.forEach((item, answerIndex) => {
                    try {
                        if (!item.data || 
                            item.data.moduleNumber === undefined || 
                            item.data.questionIndex === undefined) {
                            console.warn(`Resposta ${answerIndex} inv√°lida:`, item);
                            return;
                        }
                        
                        const key = `${item.data.moduleNumber}_${item.data.questionIndex}`;
                        const timestamp = new Date(item.data.timestamp?.seconds * 1000 || item.data.timestamp || 0);
                        
                        console.log(`Resposta ${answerIndex}: M√≥dulo ${item.data.moduleNumber}, Pergunta ${item.data.questionIndex}, Key: ${key}`);
                        console.log(`Pergunta: ${item.data.question}`);
                        console.log(`Resposta: ${item.data.answer?.substring(0, 100)}...`);
                        
                        if (!uniqueAnswers[key] || timestamp > uniqueAnswers[key].timestamp) {
                            uniqueAnswers[key] = {
                                moduleNumber: item.data.moduleNumber,
                                moduleTitle: item.data.moduleTitle || 'M√≥dulo sem t√≠tulo',
                                questionIndex: item.data.questionIndex,
                                question: item.data.question || 'Pergunta n√£o dispon√≠vel',
                                answer: item.data.answer || 'Resposta n√£o dispon√≠vel',
                                timestamp: timestamp,
                                characterCount: item.data.characterCount || item.data.answer?.length || 0
                            };
                            console.log(`‚úì Resposta √∫nica adicionada para key: ${key}`);
                        } else {
                            console.log(`‚ö† Resposta duplicada ignorada para key: ${key}`);
                        }
                    } catch (answerError) {
                        console.error(`Erro ao processar resposta ${answerIndex}:`, answerError, item);
                    }
                });
                
                console.log('Respostas √∫nicas encontradas:', Object.keys(uniqueAnswers).length);
                console.log('Keys das respostas:', Object.keys(uniqueAnswers));
                
                // Organizar respostas por m√≥dulo
                Object.values(uniqueAnswers).forEach(answer => {
                    if (!session.modules[answer.moduleNumber]) {
                        session.modules[answer.moduleNumber] = {
                            title: answer.moduleTitle,
                            answers: []
                        };
                        console.log(`Criado m√≥dulo ${answer.moduleNumber}: ${answer.moduleTitle}`);
                    }
                    
                    session.modules[answer.moduleNumber].answers.push({
                        questionIndex: answer.questionIndex,
                        question: answer.question,
                        answer: answer.answer,
                        timestamp: answer.timestamp,
                        characterCount: answer.characterCount
                    });
                });
                
                // Ordenar respostas por questionIndex em cada m√≥dulo
                Object.entries(session.modules).forEach(([moduleNum, module]) => {
                    if (module.answers && Array.isArray(module.answers)) {
                        module.answers.sort((a, b) => (a.questionIndex || 0) - (b.questionIndex || 0));
                        console.log(`M√≥dulo ${moduleNum} ordenado: ${module.answers.length} respostas`);
                    }
                });
                
                // Contar total de respostas para esta sess√£o
                const totalAnswers = Object.values(session.modules).reduce((total, module) => {
                    return total + (module.answers ? module.answers.length : 0);
                }, 0);
                
                console.log(`Sess√£o ${sessionId} processada:`, {
                    nome: session.sdrName,
                    email: session.sdrEmail,
                    status: session.status,
                    progress: session.progress,
                    totalModulos: Object.keys(session.modules).length,
                    totalRespostas: totalAnswers
                });
                
            } catch (sessionError) {
                console.error(`Erro ao processar sess√£o ${sessionId}:`, sessionError);
            }
        });
        
        console.log('=== PROCESSAMENTO CONCLU√çDO ===');
        console.log('Total de sess√µes processadas:', Object.keys(sdrData).length);
        console.log('Resumo das sess√µes:');
        Object.entries(sdrData).forEach(([sessionId, session]) => {
            const totalAnswers = Object.values(session.modules).reduce((total, module) => {
                return total + (module.answers ? module.answers.length : 0);
            }, 0);
            console.log(`- ${session.sdrName || 'Sem nome'} (${session.sdrEmail || 'Sem email'}): ${totalAnswers} respostas`);
        });
        
    } catch (error) {
        console.error('Erro cr√≠tico no processamento de dados:', error);
        sdrData = {};
    }
}

// Renderizar lista de SDRs - vers√£o com debug melhorado
function renderSDRList() {
    const sdrListEl = document.getElementById('sdrList');
    const sessions = Object.values(sdrData);
    
    console.log('=== RENDERIZAR LISTA DE SDRs ===');
    console.log('Total de sess√µes:', sessions.length);
    console.log('Dados completos das sess√µes:', sessions);
    
    if (sessions.length === 0) {
        sdrListEl.innerHTML = '<div class="no-data">Nenhum dado encontrado</div>';
        return;
    }
    
    const html = sessions.map((session, index) => {
        console.log(`--- Sess√£o ${index + 1} ---`);
        console.log('Session ID:', session.sessionId);
        console.log('Nome:', session.sdrName);
        console.log('Email:', session.sdrEmail);
        console.log('Start Time:', session.startTime);
        console.log('M√≥dulos:', session.modules);
        console.log('Progress:', session.progress);
        console.log('Status:', session.status);
        
        // Verificar se temos nome v√°lido
        const sdrName = session.sdrName && session.sdrName !== '' ? session.sdrName : 'Nome n√£o dispon√≠vel';
        const sdrEmail = session.sdrEmail && session.sdrEmail !== '' ? session.sdrEmail : 'Email n√£o dispon√≠vel';
        
        // Criar iniciais de forma mais segura
        let initials = 'NA';
        if (sdrName && sdrName !== 'Nome n√£o dispon√≠vel') {
            const nameParts = sdrName.split(' ').filter(part => part.length > 0);
            if (nameParts.length > 0) {
                initials = nameParts.map(n => n[0]).join('').toUpperCase().substring(0, 2);
            }
        }
        
        // Formatar data de in√≠cio
        let startDate = 'N/A';
        if (session.startTime) {
            try {
                if (session.startTime.seconds) {
                    startDate = new Date(session.startTime.seconds * 1000).toLocaleString('pt-BR');
                } else if (session.startTime instanceof Date) {
                    startDate = session.startTime.toLocaleString('pt-BR');
                } else {
                    startDate = new Date(session.startTime).toLocaleString('pt-BR');
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e, session.startTime);
                startDate = 'Data inv√°lida';
            }
        }
        
        // Contar respostas reais
        const totalRespostas = Object.values(session.modules).reduce((total, module) => {
            return total + (module.answers ? module.answers.length : 0);
        }, 0);
        
        console.log(`Total de respostas para ${sdrName}:`, totalRespostas);
        
        return `
            <div class="sdr-item" data-session="${session.sessionId}">
                <div class="sdr-header">
                    <div class="sdr-info" onclick="toggleAnswers('${session.sessionId}')">
                        <div class="sdr-avatar">${initials}</div>
                        <div class="sdr-details">
                            <h3>${sdrName}</h3>
                            <div class="sdr-meta">
                                ${sdrEmail} ‚Ä¢ Iniciado em: ${startDate} ‚Ä¢ ${totalRespostas} respostas
                            </div>
                        </div>
                    </div>
                    <div class="sdr-progress">
                        <div class="progress-circle" style="background: conic-gradient(#38a169 ${(session.progress || 0) * 3.6}deg, #e2e8f0 ${(session.progress || 0) * 3.6}deg)">
                            ${session.progress || 0}%
                        </div>
                        <div class="status-badge status-${session.status === 'conclu√≠do' ? 'completed' : session.status === 'pausado' ? 'paused' : 'active'}">
                            ${session.status || 'ativo'}
                        </div>
                        <button class="btn delete-btn" data-session="${session.sessionId}" 
                                style="background: #dc2626; padding: 8px 12px; font-size: 12px; margin-left: 10px;">
                            üóëÔ∏è Excluir
                        </button>
                        <button class="expand-btn" onclick="toggleAnswers('${session.sessionId}')">‚ñº</button>
                    </div>
                </div>
                <div class="sdr-answers" id="answers-${session.sessionId}">
                    ${renderAnswers(session)}
                </div>
            </div>
        `;
    }).join('');
    
    sdrListEl.innerHTML = html;
    
    // Adicionar event listeners para bot√µes de exclus√£o
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const sessionId = this.getAttribute('data-session');
            console.log('Bot√£o de exclus√£o clicado para:', sessionId);
            openDeleteModal(sessionId);
        });
    });
    
    console.log('=== RENDERIZA√á√ÉO CONCLU√çDA ===');
}

// Renderizar respostas - vers√£o corrigida
function renderAnswers(session) {
    console.log('Renderizando respostas para sess√£o:', session.sessionId, session.modules);
    
    const moduleEntries = Object.entries(session.modules);
    
    if (moduleEntries.length === 0) {
        return '<div class="no-data">Nenhuma resposta encontrada</div>';
    }
    
    return moduleEntries
        .sort(([a], [b]) => parseInt(a) - parseInt(b)) // Ordenar m√≥dulos numericamente
        .map(([moduleNum, module]) => {
            console.log(`M√≥dulo ${moduleNum}:`, module);
            
            if (!module.answers || module.answers.length === 0) {
                return `
                    <div style="margin-bottom: 25px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
                            <h4 style="margin: 0; font-size: 1.1rem; font-weight: bold;">${module.title}</h4>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Nenhuma resposta ainda</p>
                        </div>
                    </div>
                `;
            }
            
            const moduleAnswers = module.answers.map((answer, index) => {
                const timestamp = answer.timestamp ? answer.timestamp.toLocaleString('pt-BR') : 'N/A';
                const answerLength = answer.characterCount || answer.answer?.length || 0;
                const quality = answerLength >= 200 ? 'Excelente' : answerLength >= 100 ? 'Boa' : 'Precisa melhorar';
                const qualityColor = answerLength >= 200 ? '#059669' : answerLength >= 100 ? '#d97706' : '#dc2626';
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${qualityColor};">
                        <!-- Pergunta -->
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
                            <h5 style="color: #1e40af; margin: 0 0 5px 0; font-size: 0.9rem; font-weight: bold;">‚ùì PERGUNTA ${answer.questionIndex + 1}:</h5>
                            <p style="color: #1e3a8a; margin: 0; font-weight: 500; line-height: 1.4;">${answer.question}</p>
                        </div>
                        
                        <!-- Resposta -->
                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #059669; margin: 0 0 10px 0; font-size: 0.9rem; font-weight: bold;">‚úÖ RESPOSTA:</h5>
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border-left: 3px solid ${qualityColor};">
                                <p style="color: #374151; margin: 0; line-height: 1.6; white-space: pre-wrap; font-size: 0.95rem;">${answer.answer || 'Resposta n√£o encontrada'}</p>
                            </div>
                        </div>
                        
                        <!-- Metadados -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 0.85rem; color: #6b7280; flex-wrap: wrap; gap: 10px;">
                            <span>üìÖ ${timestamp}</span>
                            <span>üìù ${answerLength} caracteres</span>
                            <span style="color: ${qualityColor}; font-weight: bold;">‚≠ê ${quality}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; margin-bottom: 0;">
                        <h4 style="margin: 0; font-size: 1.1rem; font-weight: bold;">${module.title}</h4>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">${module.answers.length} resposta(s) ‚Ä¢ M√≥dulo ${moduleNum}</p>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 0 0 12px 12px; border: 1px solid #e2e8f0; border-top: none;">
                        ${moduleAnswers}
                    </div>
                </div>
            `;
        }).join('');
}

// Toggle respostas
function toggleAnswers(sessionId) {
    console.log('toggleAnswers chamada para:', sessionId);
    const answersEl = document.getElementById(`answers-${sessionId}`);
    const expandBtn = document.querySelector(`[data-session="${sessionId}"] .expand-btn`);
    const sdrItem = document.querySelector(`[data-session="${sessionId}"]`);
    
    if (!answersEl || !expandBtn) {
        console.error('Elementos n√£o encontrados para sessionId:', sessionId);
        return;
    }
    
    if (answersEl.classList.contains('expanded')) {
        answersEl.classList.remove('expanded');
        expandBtn.textContent = '‚ñº';
        sdrItem.classList.remove('expanded');
    } else {
        answersEl.classList.add('expanded');
        expandBtn.textContent = '‚ñ≤';
        sdrItem.classList.add('expanded');
    }
}

// Atualizar estat√≠sticas com tratamento de erro
function updateStats() {
    try {
        console.log('Atualizando estat√≠sticas. SDR Data:', sdrData);
        
        // Verificar se sdrData existe e tem dados
        if (!sdrData || typeof sdrData !== 'object') {
            console.warn('sdrData n√£o definido ou inv√°lido');
            document.getElementById('totalSDRs').textContent = '0';
            document.getElementById('activeSessions').textContent = '0';
            document.getElementById('completedTrainings').textContent = '0';
            document.getElementById('totalAnswers').textContent = '0';
            return;
        }
        
        const sessions = Object.values(sdrData);
        console.log('Sessions para estat√≠sticas:', sessions.length);
        
        // Calcular estat√≠sticas com verifica√ß√µes de seguran√ßa
        const totalSDRs = sessions.length;
        
        const activeSessions = sessions.filter(s => {
            return s && s.status && s.status === 'ativo';
        }).length;
        
        const completedTrainings = sessions.filter(s => {
            return s && s.status && s.status === 'conclu√≠do';
        }).length;
        
        const totalAnswers = sessions.reduce((total, s) => {
            if (!s || !s.modules) return total;
            
            const moduleAnswers = Object.values(s.modules).reduce((moduleTotal, module) => {
                if (!module || !module.answers || !Array.isArray(module.answers)) return moduleTotal;
                return moduleTotal + module.answers.length;
            }, 0);
            
            return total + moduleAnswers;
        }, 0);
        
        // Atualizar interface
        document.getElementById('totalSDRs').textContent = totalSDRs;
        document.getElementById('activeSessions').textContent = activeSessions;
        document.getElementById('completedTrainings').textContent = completedTrainings;
        document.getElementById('totalAnswers').textContent = totalAnswers;
        
        console.log('Estat√≠sticas atualizadas:', {
            totalSDRs,
            activeSessions,
            completedTrainings,
            totalAnswers
        });
        
    } catch (error) {
        console.error('Erro ao atualizar estat√≠sticas:', error);
        
        // Definir valores padr√£o em caso de erro
        document.getElementById('totalSDRs').textContent = '0';
        document.getElementById('activeSessions').textContent = '0';
        document.getElementById('completedTrainings').textContent = '0';
        document.getElementById('totalAnswers').textContent = '0';
    }
}

// Aplicar filtros
function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const searchFilter = document.getElementById('searchSDR').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    
    const sdrItems = document.querySelectorAll('.sdr-item');
    
    sdrItems.forEach(item => {
        const sessionId = item.dataset.session;
        const session = sdrData[sessionId];
        
        let show = true;
        
        // Filtro por status
        if (statusFilter && session.status !== statusFilter) {
            show = false;
        }
        
        // Filtro por busca
        if (searchFilter && !session.sdrName.toLowerCase().includes(searchFilter) && !session.sdrEmail.toLowerCase().includes(searchFilter)) {
            show = false;
        }
        
        // Filtro por data
        if (dateFilter && session.startTime) {
            const sessionDate = new Date(session.startTime.seconds ? session.startTime.seconds * 1000 : session.startTime);
            const filterDate = new Date(dateFilter);
            if (sessionDate.toDateString() !== filterDate.toDateString()) {
                show = false;
            }
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

// Exportar dados
function exportData() {
    const sessions = Object.values(sdrData);
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Nome,Email,Status,Progresso,M√≥dulo,Pergunta,Resposta,Data\n" +
        sessions.map(session => 
            session.answers.map(answer => 
                `"${session.sdrName}","${session.sdrEmail}","${session.status}","${session.progress}%","${answer.moduleTitle}","${answer.question}","${answer.answer}","${new Date(answer.timestamp.seconds * 1000).toLocaleString('pt-BR')}"`
            ).join('\n')
        ).join('\n');
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `treinamento_sdr_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Auto-refresh a cada 30 segundos
setInterval(() => {
    if (document.getElementById('adminPanel').classList.contains('active')) {
        loadData();
    }
}, 30000);

// Vari√°veis para exclus√£o
let sessionToDelete = null;

// Abrir modal de exclus√£o - vers√£o simplificada
function openDeleteModal(sessionId) {
    console.log('openDeleteModal chamada com sessionId:', sessionId);
    const session = sdrData[sessionId];
    if (!session) {
        console.error('Sess√£o n√£o encontrada:', sessionId);
        alert('Erro: Sess√£o n√£o encontrada');
        return;
    }
    
    // Usar confirm simples ao inv√©s de modal customizado
    const confirmMessage = `‚ö†Ô∏è CONFIRMAR EXCLUS√ÉO\n\nTem certeza que deseja excluir o treinamento de:\n\nüë§ ${session.sdrName}\nüìß ${session.sdrEmail}\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\nTodos os dados ser√£o removidos permanentemente.`;
    
    if (confirm(confirmMessage)) {
        console.log('Usu√°rio confirmou exclus√£o');
        deleteTraining(sessionId);
    } else {
        console.log('Usu√°rio cancelou exclus√£o');
    }
}

// Fun√ß√£o para excluir treinamento
async function deleteTraining(sessionId) {
    try {
        console.log('Iniciando exclus√£o para sessionId:', sessionId);
        
        // Mostrar feedback visual
        const deleteBtn = document.querySelector(`[data-session="${sessionId}"] .delete-btn`);
        if (deleteBtn) {
            deleteBtn.textContent = 'üîÑ Excluindo...';
            deleteBtn.disabled = true;
        }
        
        // Buscar todos os documentos relacionados √† sess√£o
        console.log('Buscando documentos para sessionId:', sessionId);
        const snapshot = await db.collection('sdr_training')
            .where('data.sessionId', '==', sessionId)
            .get();
        
        console.log('Documentos encontrados:', snapshot.size);
        
        if (snapshot.empty) {
            alert('Nenhum documento encontrado para excluir.');
            return;
        }
        
        // Excluir todos os documentos em lote
        const batch = db.batch();
        snapshot.forEach(doc => {
            console.log('Adicionando documento ao lote de exclus√£o:', doc.id);
            batch.delete(doc.ref);
        });
        
        console.log('Executando exclus√£o em lote...');
        await batch.commit();
        console.log('Exclus√£o conclu√≠da com sucesso');
        
        // Atualizar interface
        delete sdrData[sessionId];
        renderSDRList();
        updateStats();
        
        alert('‚úÖ Treinamento exclu√≠do com sucesso!');
        
    } catch (error) {
        console.error('Erro ao excluir treinamento:', error);
        alert('‚ùå Erro ao excluir treinamento: ' + error.message);
        
        // Resetar bot√£o em caso de erro
        const deleteBtn = document.querySelector(`[data-session="${sessionId}"] .delete-btn`);
        if (deleteBtn) {
            deleteBtn.textContent = 'üóëÔ∏è Excluir';
            deleteBtn.disabled = false;
        }
    }
}

// Fechar modal de exclus√£o (manter para compatibilidade)
function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) {
        modal.style.display = 'none';
    }
    sessionToDelete = null;
}

// Confirmar exclus√£o (manter para compatibilidade)
function confirmDelete() {
    if (sessionToDelete) {
        deleteTraining(sessionToDelete);
        closeDeleteModal();
    }
}

// Fun√ß√£o para limpar todos os dados de teste (bot√£o adicional)
async function clearAllTestData() {
    const confirm1 = confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° excluir TODOS os treinamentos!\n\nTem certeza absoluta que deseja continuar?');
    if (!confirm1) return;
    
    const confirm2 = confirm('üö® √öLTIMA CHANCE: Todos os dados ser√£o perdidos permanentemente!\n\nConfirma a exclus√£o completa?');
    if (!confirm2) return;
    
    try {
        // Buscar todos os documentos
        const snapshot = await db.collection('sdr_training').get();
        
        if (snapshot.empty) {
            alert('Nenhum dado encontrado para excluir.');
            return;
        }
        
        // Excluir em lotes de 500 (limite do Firestore)
        const batchSize = 500;
        const batches = [];
        let currentBatch = db.batch();
        let currentBatchSize = 0;
        
        snapshot.forEach(doc => {
            currentBatch.delete(doc.ref);
            currentBatchSize++;
            
            if (currentBatchSize === batchSize) {
                batches.push(currentBatch);
                currentBatch = db.batch();
                currentBatchSize = 0;
            }
        });
        
        // Adicionar o √∫ltimo lote se n√£o estiver vazio
        if (currentBatchSize > 0) {
            batches.push(currentBatch);
        }
        
        // Executar todos os lotes
        await Promise.all(batches.map(batch => batch.commit()));
        
        // Limpar dados locais e interface
        sdrData = {};
        renderSDRList();
        updateStats();
        
        alert(`‚úÖ Todos os ${snapshot.size} registros foram exclu√≠dos com sucesso!`);
        
    } catch (error) {
        console.error('Erro ao limpar dados:', error);
        alert('‚ùå Erro ao limpar dados. Tente novamente.');
    }
}

// Toggle expans√£o de respostas individuais
function toggleAnswerExpansion(moduleNum, answerIndex, button) {
    const answerId = `answer-${moduleNum}-${answerIndex}`;
    const answerElement = document.getElementById(answerId);
    
    if (!answerElement) return;
    
    if (answerElement.classList.contains('collapsed')) {
        // Expandir
        answerElement.classList.remove('collapsed');
        // Buscar resposta completa dos dados
        const sessionId = Object.keys(sdrData).find(sessionId => 
            sdrData[sessionId].modules[moduleNum] && 
            sdrData[sessionId].modules[moduleNum].answers[answerIndex]
        );
        
        if (sessionId) {
            const fullAnswer = sdrData[sessionId].modules[moduleNum].answers[answerIndex].answer;
            answerElement.textContent = fullAnswer;
        }
        
        button.textContent = 'Ver menos';
    } else {
        // Colapsar
        answerElement.classList.add('collapsed');
        const sessionId = Object.keys(sdrData).find(sessionId => 
            sdrData[sessionId].modules[moduleNum] && 
            sdrData[sessionId].modules[moduleNum].answers[answerIndex]
        );
        
        if (sessionId) {
            const fullAnswer = sdrData[sessionId].modules[moduleNum].answers[answerIndex].answer;
            const preview = fullAnswer.length > 200 ? fullAnswer.substring(0, 200) + '...' : fullAnswer;
            answerElement.textContent = preview;
        }
        
        button.textContent = 'Ver resposta completa';
    }
}

// Toggle expans√£o de m√≥dulos
function toggleModuleAnswers(moduleNum) {
    const moduleAnswers = document.getElementById(`module-answers-${moduleNum}`);
    if (!moduleAnswers) return;
    
    if (moduleAnswers.classList.contains('expanded')) {
        moduleAnswers.classList.remove('expanded');
    } else {
        moduleAnswers.classList.add('expanded');
    }
}
</script>
</body>
</html>
